\name{NPADistThresholdDetermination}
\alias{NPADistThresholdDetermination}
\title{
Estimate Optimal Distance Threshold for Spatial Graph Analysis
}
\description{
Analyzes spatial transcriptomic cell-gene coordinate data to compute network metrics across a range of distances, generating diagnostic plots and estimating the optimal graph distance threshold based on connectedness and sparsity
}
\usage{
NPADistThresholdDetermination(
  CellFile,
  OutputDir,
  MetricsExcelPath
)
}
\arguments{
  \item{CellFile}{
Path to a CSV file containing cellular metadata (including {cell_area}) used to calculate diameter range
  }
  \item{OutputDir}{
Directory containing cell-gene CSV files (as generated by {\link{NPADataAcqOrg}}) used to compute graph properties at various thresholds
  }
  \item{MetricsExcelPath}{
Destination path to save a multi-sheet Excel workbook with graph metrics for each distance threshold tested
  }
}
\details{
This function is the second step in the spatial network analysis pipeline.
It first calculates a realistic range of diameters from the input {CellFile} using estimated cell diameters.
It then iterates through this range and computes network properties (e.g., degree, node count, NA and zero values) for every gene within each cell at each diameter threshold.
These metrics are saved into a multi-sheet Excel workbook for transparency and post-hoc validation.
A diagnostic plot is also generated showing how connectedness and sparsity change across thresholds.
Finally, a LOESS smoothing method is used to determine the threshold where connectedness and sparsity curves intersect, providing a data-driven optimal graph diameter.
}
\value{
A single numeric value indicating the estimated optimal distance threshold (in spatial units) to be used in graph construction

Also written to disk:
\item{MetricsExcelPath}{Excel workbook containing per-diameter metrics across all sampled cell-gene combinations.}
\item{Distance Threshold Plot.pdf}{A visual diagnostic plot saved to the working directory.}
}
\references{
\url{https://www.10xgenomics.com/products/xenium}

For Graph Metrics: igraph Documentation \url{https://igraph.org/r/}
}
\author{
Daivic B. Akala \email{daivicakala@gmail.com}
}
\note{
This function assumes that cell-gene data have been preprocessed and saved in a nested folder structure (OutputDir) using {\link{NPADataAcqOrg}}
}

\seealso{
\code{\link{NPADataAcqOrg}}, \code{\link{NPANetPropsCalc}}, {\link[igraph]{graph_from_adjacency_matrix}}, {\link[openxlsx]{writeData}}
}
\examples{
CellFile <- "path/to/GroupedSample.csv"
OutputDir <- "path/to/OutputDir"
MetricsExcelPath <- "path/to/MetricsWorkbook.xlsx"

opt_thresh <- NPADistThresholdDetermination(
  CellFile = CellFile,
  OutputDir = OutputDir,
  MetricsExcelPath = MetricsExcelPath
)
}
\keyword{Spatial Transcriptomics}
\keyword{Networks}
\keyword{Graph}
\concept{Spatial Graph Construction}
\concept{Network Threshold Estimation}
